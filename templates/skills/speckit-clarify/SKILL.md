
---
name: speckit-clarify
description: Identify under-specified areas in current feature specifications through highly targeted clarification questions, and encode answers back into specifications in dependency order.
license: MIT
compatibility: Requires speckit workflow.
metadata:
  author: speckit
  version: "1.0"
---

通过提出高度针对性的澄清问题，识别当前功能规范中未充分说明的领域，并按照依赖顺序将答案编码回规范中。

## 用户输入

```
$ARGUMENTS
```

在继续之前，你**必须**考虑用户输入（如果不为空）。用户可以通过以下方式提供参考文档：
- **文件路径**：直接列出本地文件路径
- **IDE 上下文**：提及当前打开的文件或选中的代码块
- **外部链接**：提供可访问的 URL
- **自然语言描述**：用户直接在对话中粘贴的文本片段

## 概述

**目标**：检测并减少活跃功能规范中的模糊性、缺失决策点或文档间的不一致，并将澄清内容直接记录在规范文件中，确保规范与关联文档保持对齐。

**注意**：此澄清工作流应在调用 `/speckit.plan` 之前运行（并完成）。如果用户明确表示他们跳过澄清（例如，探索性原型），你可以继续，但必须警告下游返工风险增加。

## 执行步骤

1. **设置**：从仓库根目录运行 `.specify/scripts/bash/create-new-feature.sh --json` **一次**。解析最小 JSON 负载：
   - `FEATURE_DIR`
   - `FEATURE_SPEC`
   - 可选捕获 `IMPL_PLAN`、`TASKS` 用于未来的链式流程

2. **加载当前规范**：读取 `FEATURE_SPEC` 和关联文档。执行**跨文档多重比对与知识提取**以识别：
   - 文档间的冲突
   - 逻辑断层
   - 计划/任务中引入但规范中未定义的隐性需求
   - 术语一致性

   **扫描类别：**
   - 功能范围和行为
   - 领域和数据模型
   - 交互和 UX 流程
   - 非功能质量属性
   - 集成和外部依赖
   - 边缘情况和故障处理
   - 约束和权衡
   - 术语和一致性

3. **（内部）生成优先级队列**：应用约束：
   - 识别问题间的依赖关系
   - 按依赖顺序和优先级排序
   - 总共建议的问题 ≤ 10
   - 每个问题必须可以通过以下方式回答：
     * 简短的多项选择（2-5 个选项），或
     * 单词/短语答案（≤5 个词）
   - 优先减少下游返工风险的澄清

4. **分组提问流程（交互式）**：
   - **以组为单位**提出问题，每组最多 **5** 个逻辑相关的问题
   - 对于每个多项选择题：
     * **分析所有选项**并确定**推荐的选项**
     * 格式：
       ```
       **Q[n]：<问题文本>**
       **推荐：** 选项 [X] - <推理>
       | 选项 | 描述 |
       |--------|-------------|
       | A | ... |
       | B | ... |
       ```
   - 对于每个简答题：
     * 提供你的**建议答案**及简要推理

5. **每次接受答案后的增量集成**：
   - 维护规范的内存表示
   - 确保 `## Clarifications` 部分存在（如果缺失则创建）
   - 追加项目符号行：`- Q：<问题> → A：<最终答案>`
   - 立即将澄清应用到最合适的部分
   - 每次集成后保存规范文件（原子覆盖）

6. **验证**：每次写入后和最终执行：
   - 每个接受的答案只包含一个项目符号
   - 总共询问（接受）的问题 ≤ 10
   - 更新的部分不包含持续的模糊占位符
   - 没有保留矛盾的早期声明
   - Markdown 结构有效

7. **将更新的规范**写回 `FEATURE_SPEC`。

8. **完成报告**：
   - 问答对的数量
   - 更新规范的路径
   - 涉及的部分
   - 按类别划分的覆盖范围摘要表
   - 建议的下一个命令

## 行为规则

- 如果没有发现有意义的模糊性："未检测到值得正式澄清的关键模糊性。"
- 如果规范文件缺失：引导用户先运行 `/speckit.specify`
- 永远不要超过总共 10 个询问的问题
- 尊重用户的提前终止信号（"stop"、"done"、"proceed"）
- 如果开始时没有提问（完全覆盖），输出紧凑的覆盖范围摘要然后建议前进

## 优先级上下文

{ARGS}
